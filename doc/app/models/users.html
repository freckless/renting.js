<!DOCTYPE html><html lang="en"><head><title>app/models/users</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="app/models/users"><meta name="groc-project-path" content="app/models/users.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">app/models/users.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="user-model">User Model</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Este modelo é o encargado de relacionar os usuarios cós seus respectivos
datos na base de datos e tamén de xestionar as suas relacións.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-pi">
'use strict'</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="dependencias-do-mdulo">Dependencias do módulo</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(global.root_path + <span class="hljs-string">'/app/config/loader.js'</span>),
    mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>),
    Schema = mongoose.Schema,
    DBUtils = <span class="hljs-built_in">require</span>(config.paths.utils + <span class="hljs-string">'/database.js'</span>),
    crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="esquema-de-datos-do-modelo">Esquema de datos do modelo</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> UserSchema = <span class="hljs-keyword">new</span> Schema({
    <span class="hljs-string">'username'</span>: { <span class="hljs-string">'type'</span>: <span class="hljs-built_in">String</span>, <span class="hljs-string">'required'</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">'index'</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-string">'hashed_password'</span>: { <span class="hljs-string">'type'</span>: <span class="hljs-built_in">String</span>, <span class="hljs-string">'required'</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-string">'salt'</span>: { <span class="hljs-string">'type'</span>: <span class="hljs-built_in">String</span>, <span class="hljs-string">'required'</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-string">'token'</span>: { <span class="hljs-string">'type'</span>: <span class="hljs-built_in">String</span> },
    <span class="hljs-string">'mail'</span>: { <span class="hljs-string">'type'</span>: <span class="hljs-built_in">String</span>, <span class="hljs-string">'required'</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">'index'</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-string">'firstname'</span>: { <span class="hljs-string">'type'</span>: <span class="hljs-built_in">String</span>, <span class="hljs-string">'required'</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-string">'lastname'</span>: { <span class="hljs-string">'type'</span>: <span class="hljs-built_in">String</span>, <span class="hljs-string">'required'</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-string">'phone'</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-string">'city'</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-string">'zipcode'</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-string">'address'</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-string">'country'</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-string">'company'</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-string">'born_at'</span>: { <span class="hljs-string">'type'</span>: <span class="hljs-built_in">Date</span>, <span class="hljs-string">'required'</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-string">'sex'</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-string">'picture'</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-string">'document'</span>: { <span class="hljs-string">'type'</span>: <span class="hljs-built_in">String</span>, <span class="hljs-string">'number'</span>: <span class="hljs-built_in">String</span> },
    <span class="hljs-string">'newsletter'</span>: <span class="hljs-built_in">Boolean</span>,
    <span class="hljs-string">'created_at'</span>: <span class="hljs-built_in">Date</span>,
    <span class="hljs-string">'modified_at'</span>: <span class="hljs-built_in">Date</span>,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Relations</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-string">'role'</span>: { <span class="hljs-string">'type'</span>: Schema.Types.ObjectId, ref: <span class="hljs-string">'Role'</span> }
});</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="campos-virtuais">Campos virtuais</h2>
<p>O campo password non existe na base de datos xa que este se garda
como unha cadena encriptada polo tanto, esta función serve para
encriptar o password é gardalo no campo hashed_password sen ter que
manexar estos datos no controlador ou componente.</p></div></div><div class="code"><div class="wrapper">UserSchema.virtual(<span class="hljs-string">'password'</span>).set(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(password)</span> {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Creamos unha nova salt (frase secreta)</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">this</span>.salt = <span class="hljs-keyword">this</span>.makeSalt();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Codificamos o password</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">this</span>.hashed_password = <span class="hljs-keyword">this</span>.encryptPassword(password);
});</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="validacins">Validacións</h2>
<p>Configuramos as validacións adicionais necesarias</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="o-nome-de-usuario-debe-ser-nico">O nome de usuario debe ser único</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">UserSchema.path(<span class="hljs-string">'username'</span>).validate(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val, callback)</span> {</span>
    DBUtils.validate_uniqueness(<span class="hljs-string">'User'</span>, <span class="hljs-string">'username'</span>, val, callback);
}, <span class="hljs-string">'Username should be unique'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="o-e-mail-debe-ser-nico">O e-mail debe ser único</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">UserSchema.path(<span class="hljs-string">'mail'</span>).validate(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val, callback)</span> {</span>
    DBUtils.validate_uniqueness(<span class="hljs-string">'User'</span>, <span class="hljs-string">'mail'</span>, val, callback);
}, <span class="hljs-string">'Mail should be unique'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="mtodos">Métodos</h2>
<p>Definimos os métodos utilizados polo modelo</p></div></div><div class="code"><div class="wrapper">UserSchema.methods = {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Función para crear unha nova cadea para usar de frase secreta.</p></div></div><div class="code"><div class="wrapper">    makeSalt: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">return</span> crypto.randomBytes(<span class="hljs-number">16</span>).toString(<span class="hljs-string">'base64'</span>);
    },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Función para encriptar o password coa &quot;salt&quot; asignada no modelo</p></div></div><div class="code"><div class="wrapper">    encryptPassword: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(password)</span> {</span>
        <span class="hljs-keyword">if</span> ( ! password || ! <span class="hljs-keyword">this</span>.salt) { <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>; }
        <span class="hljs-keyword">return</span> crypto.pbkdf2Sync(password, <span class="hljs-keyword">this</span>.salt, <span class="hljs-number">10000</span>, <span class="hljs-number">64</span>).toString(<span class="hljs-string">'base64'</span>);
    },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Función para autenticar o usuario é decir, comprobar se as credenciais son correctas</p></div></div><div class="code"><div class="wrapper">    authenticate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(plainText)</span> {</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.encryptPassword(plainText) === <span class="hljs-keyword">this</span>.hashed_password;
    }
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Exportamos o modelo</p></div></div><div class="code"><div class="wrapper">module.exports = mongoose.model(<span class="hljs-string">'User'</span>, UserSchema);</div></div></div></div></body></html>
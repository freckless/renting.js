<!DOCTYPE html><html lang="en"><head><title>config/express</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="config/express"><meta name="groc-project-path" content="config/express.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">config/express.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="mdulo-de-configuracin-de-express">Módulo de configuración de express</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Neste arquivo ocuparémonos de configurar o framework express
para que funcione o noso gusto.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-pi">
'use strict'</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="dependencias-do-mdulo">Dependencias do módulo</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> config = global.config,
    lodash = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>),
    multiparty = <span class="hljs-built_in">require</span>(<span class="hljs-string">'connect-multiparty'</span>),
    compression = <span class="hljs-built_in">require</span>(<span class="hljs-string">'compression'</span>),
    morgan = <span class="hljs-built_in">require</span>(<span class="hljs-string">'morgan'</span>),
    body_parser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser'</span>),
    method_override = <span class="hljs-built_in">require</span>(<span class="hljs-string">'method-override'</span>),
    cookie_parser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cookie-parser'</span>),
    cookie_session = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cookie-session'</span>),
    flash = <span class="hljs-built_in">require</span>(<span class="hljs-string">'connect-flash'</span>),
    ejs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ejs'</span>),
    ejs_layouts = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express-ejs-layouts'</span>),
    helpers = <span class="hljs-built_in">require</span>(config.paths.helpers + <span class="hljs-string">'loader.js'</span>),
    router = <span class="hljs-built_in">require</span>(config.paths.components + <span class="hljs-string">'router.js'</span>),
    i18n = <span class="hljs-built_in">require</span>(config.paths.components + <span class="hljs-string">'i18n.js'</span>),
    auth = <span class="hljs-built_in">require</span>(config.paths.components + <span class="hljs-string">'auth.js'</span>),
    serve_static = <span class="hljs-built_in">require</span>(<span class="hljs-string">'serve-static'</span>),
    serve_favicon = <span class="hljs-built_in">require</span>(<span class="hljs-string">'serve-favicon'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="configuracin">Configuración</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app)</span> {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Configuramos o servidor para que mostre o stack en caso de error</p></div></div><div class="code"><div class="wrapper">    app.set(<span class="hljs-string">'showStackError'</span>, <span class="hljs-literal">true</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Configuramos o porto</p></div></div><div class="code"><div class="wrapper">    app.set(<span class="hljs-string">'port'</span>, config.port);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Prettify HTML.</p></div></div><div class="code"><div class="wrapper">    app.locals.pretty = <span class="hljs-literal">true</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Configuramos express para que comprima os arquivos antes
de envialos ó cliente.</p></div></div><div class="code"><div class="wrapper">    app.use(compression({</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Filtramos só os arquivos que queremos que se compriman.</p></div></div><div class="code"><div class="wrapper">        filter: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> (<span class="hljs-regexp">/json|text|javascript|css/</span>).text;
        },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Sinalamos o nivel de comprensión que se aplicará ó recursos
do 0 o 10, de menor a maior.</p></div></div><div class="code"><div class="wrapper">        level: <span class="hljs-number">9</span>
    }));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Buscamos recursos státicos que podan responder a consulta e se non cargamos
o necesario para tratar de responder a consulta</p></div></div><div class="code"><div class="wrapper">    app.use(serve_favicon(config.paths.webroot + <span class="hljs-string">'/favicon.ico'</span>));
    app.use(serve_static(config.paths.webroot));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Configuramos o directorio das vistas e o motor de plantilla que vamos a utilizar.</p></div></div><div class="code"><div class="wrapper">    app.set(<span class="hljs-string">'views'</span>, config.paths.root + <span class="hljs-string">'/app/views'</span>);
    app.engine(<span class="hljs-string">'ejs'</span>, ejs.renderFile);
    app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">'ejs'</span>);
    app.set(<span class="hljs-string">'layout'</span>, <span class="hljs-string">'template'</span>);
    app.use(ejs_layouts);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="configuramos-os-middlewares-dos-que-vai-a-facer-uso-o-servidor">Configuramos os middlewares dos que vai a facer uso o servidor.</h2>
<p>CookieParser para manexar as cookies dunha forma máis sinxela.</p></div></div><div class="code"><div class="wrapper">    app.use(cookie_parser());</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Os encargados de recoller información enviada mediante POST, PUT...</p></div></div><div class="code"><div class="wrapper">    app.use(body_parser.json());
    app.use(body_parser.urlencoded({extended: <span class="hljs-literal">false</span>}));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Activamos a opción de recoller arquivos enviados dende formularios
é decir datos enviados mediante enctype multipart/form-data.</p></div></div><div class="code"><div class="wrapper">    app.use(multiparty());</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>MethodOverride é realmente útil para enviar datos mediante métodos non soportados
polo navegador como PUT, DELETE... simplemente engadindo ?_method=PUT a URL.</p></div></div><div class="code"><div class="wrapper">    app.use(method_override());</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Activamos o almacenamento de sesions na base de datos.</p></div></div><div class="code"><div class="wrapper">    app.use(cookie_session({
        secret: config.sessions.secret,
        name: config.sessions.name
    }));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Activamos o uso de mensaxes &quot;flash&quot; para notificacións</p></div></div><div class="code"><div class="wrapper">    app.use(flash());
    app.use(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> {</span>
        res.locals.flash = req.flash();
        next();
    });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Engadimos a consulta á resposta para poder acceder a ela dende as vistas ou controladores.</p></div></div><div class="code"><div class="wrapper">    app.use(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> {</span>
        res.locals.req = req;
        next();
    });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Engadimos lodash ós locals para acceder a el dende as vistas</p></div></div><div class="code"><div class="wrapper">    app.use(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> {</span>
        res.locals._ = lodash;
        next();
    });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Helpers, os axudantes que utilizaremos para a xeneración de vistas e máis cousas.</p></div></div><div class="code"><div class="wrapper">    app.use(helpers());</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Sistema de internacionalización</p></div></div><div class="code"><div class="wrapper">    app.use(i18n.init());</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Sistema de autenticación</p></div></div><div class="code"><div class="wrapper">    app.use(auth.init());</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Lanzamos o enrutador para redireccionar cada consulta o controlador correspondente</p></div></div><div class="code"><div class="wrapper">    app.use(router.init(app));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Se estamos en entorno de desenrolo activamos o logger para ver
as consultas que se fan en cada momento.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (process.env.NODE_ENV === <span class="hljs-string">'development'</span>) {
        app.use(morgan(<span class="hljs-string">'dev'</span>));
    }
};</div></div></div></div></body></html>
"use strict";angular.module("adminApp",["ngResource","ngTouch","ngRoute","ngLocale","pascalprecht.translate","ui.bootstrap","ui.utils","lr.upload","ui.sortable"]),angular.module("adminApp").config(["$locationProvider","$routeProvider","$translateProvider",function($locationProvider,$routeProvider,$translateProvider){$translateProvider.useUrlLoader("/locale"),$translateProvider.preferredLanguage("es"),$locationProvider.hashPrefix("!"),$routeProvider.otherwise({redirectTo:"/"})}]),angular.module("adminApp").run(function($rootScope,$timeout,$location,$translate,$locale,UserService){$rootScope.$location=$location,$rootScope.$translate=$translate,$rootScope.$locale=$locale,$rootScope.$available_languages=["es","en"],$timeout(function(){UserService.get({id:$rootScope.user}).$promise.then(function(User){$rootScope.user=User})}),$rootScope.$on("$routeChangeStart",function(){$rootScope.is_loading=!0}),$rootScope.$on("$routeChangeSuccess",function(){$rootScope.is_loading=!1})}),angular.module("adminApp").factory("ApartmentService",function($resource){return $resource("/admin/apartments/:id",{id:"@_id"},{update:{method:"PUT"}})}),angular.module("adminApp").factory("BookingService",function($resource){return $resource("/admin/bookings/:id",{id:"@_id"},{update:{method:"PUT"}})}),angular.module("adminApp").factory("CountryService",function($resource){return $resource("/admin/countries/:id",{id:"@_id"},{update:{method:"PUT"}})}),angular.module("adminApp").factory("ProvinceService",function($resource){return $resource("/admin/provinces/:id",{id:"@_id"},{update:{method:"PUT"}})}),angular.module("adminApp").factory("ServiceService",function($resource){return $resource("/admin/services/:id",{id:"@_id"},{update:{method:"PUT"}})}),angular.module("adminApp").factory("SpotService",function($resource){return $resource("/admin/spots/:id",{id:"@_id"},{update:{method:"PUT"}})}),angular.module("adminApp").factory("TownService",function($resource){return $resource("/admin/towns/:id",{id:"@_id"},{update:{method:"PUT"}})}),angular.module("adminApp").factory("UserService",function($resource){return $resource("/admin/users/:id",{id:"@_id"},{update:{method:"PUT"}})}),angular.module("adminApp").factory("$flash",function($rootScope){var queue=[],show=function(){queue.length>0?($rootScope.flash_message=queue[0],queue.shift()):$rootScope.flash_message=null};return $rootScope.$on("$routeChangeSuccess",function(){show()}),{show:function(){show()},set:function(type,message){queue.push({type:type,message:message})}}}),angular.module("adminApp").directive("backButton",function(){return{restrict:"A",link:function(scope,element){element.addClass("back-button"),element.bind("click",function(){window.history.back()})}}}),angular.module("adminApp").directive("ngMatch",function(){return{require:"ngModel",scope:{ngMatch:"="},link:function(scope){scope.$parent.$watch(function(){console.log(scope.ngMatch)})}}}),angular.module("adminApp").config(["$routeProvider",function($routeProvider){$routeProvider.when("/apartments",{templateUrl:"assets/js/admin/views/apartments/index.html",controller:"ApartmentsIndexCtrl",resolve:{Apartments:function(ApartmentService){return ApartmentService.query().$promise},Countries:function(CountryService){return CountryService.query().$promise}}}).when("/apartments/create",{templateUrl:"assets/js/admin/views/apartments/form.html",controller:"ApartmentsFormCtrl",resolve:{Apartment:function(ApartmentService,$rootScope){return new ApartmentService({services:[],user:$rootScope.user._id})},Spots:function(SpotService){return SpotService.query().$promise},Countries:function(CountryService){return CountryService.query().$promise},Services:function(ServiceService){return ServiceService.query().$promise},Owners:function(UserService){return UserService.query({group:3}).$promise}}}).when("/apartments/edit/:id",{templateUrl:"assets/js/admin/views/apartments/form.html",controller:"ApartmentsFormCtrl",resolve:{Apartment:function($rootScope,ApartmentService,$route){return ApartmentService.get({id:$route.current.params.id}).$promise},Spots:function(SpotService){return SpotService.query().$promise},Countries:function(CountryService){return CountryService.query().$promise},Services:function(ServiceService){return ServiceService.query().$promise},Owners:function(UserService){return UserService.query({group:3}).$promise}}}).when("/apartments/apartments/:id",{templateUrl:"assets/js/admin/views/apartments/apartments.html",controller:"ApartmentsApartmentsCtrl",resolve:{Apartment:function($rootScope,ApartmentService,$route){return ApartmentService.get({id:$route.current.params.id}).$promise}}}).when("/apartments/images/:id",{templateUrl:"assets/js/admin/views/apartments/images.html",controller:"ApartmentsImagesCtrl",resolve:{Apartment:function($rootScope,ApartmentService,$route){return ApartmentService.get({id:$route.current.params.id}).$promise}}})}]),angular.module("adminApp").controller("ApartmentsIndexCtrl",function($rootScope,$filter,$flash,$scope,Apartments,Countries,ProvinceService,TownService){$rootScope.current_section="apartments",$scope.apartments=Apartments,$scope.search=$rootScope.apartment_search||{},$scope.countries=Countries,$scope.provinces=$scope.towns=[],$scope.$watch("search",function(){$rootScope.apartment_search=$scope.search}),$scope.$watch("search.country",function(country){country?$scope.provinces=ProvinceService.query({country:country}):($scope.provinces=$scope.towns=[],delete $scope.search.country,delete $scope.search.province,delete $scope.search.town)}),$scope.$watch("search.province",function(province){province?$scope.towns=TownService.query({province:province}):($scope.towns=[],delete $scope.search.province,delete $scope.search.town)}),$scope.$watch("search.town",function(town){town||delete $scope.search.town}),$scope.deleteApartment=function($index){confirm($filter("translate")("admin.are_you_sure"))&&$scope.apartments[$index].$delete(function(){$scope.apartments.splice($index,1),$flash.set("success",$filter("translate")("admin.apartments.apartment_has_been_delete")),$flash.show()})}}),angular.module("adminApp").controller("ApartmentsFormCtrl",function($rootScope,$scope,$translate,$filter,$flash,$location,Apartment,Spots,Countries,Services,ProvinceService,TownService,Owners){$rootScope.current_section="apartments",$scope.active_language=$translate.use(),$scope.apartment=Apartment,$scope.owners=Owners,$scope.spots=Spots,$scope.services=Services,$scope.countries=Countries,$scope.provinces=$scope.towns=[],$scope.setActiveLanguage=function(language){$scope.active_language=language},$scope.loadProvinces=function(){var country=$scope.apartment.country;country?$scope.provinces=ProvinceService.query({country:country}):($scope.provinces=[],$scope.towns=[])},$scope.loadTowns=function(){var province=$scope.apartment.province;$scope.towns=province?TownService.query({province:province}):[]},Apartment._id?($scope.action="editing",$scope.loadProvinces(),$scope.loadTowns()):$scope.action="creating",$scope.activedService=function($id){return-1!==$scope.apartment.services.indexOf($id)?!0:!1},$scope.toggleService=function($id){if($scope.activedService($id)){var index=$scope.apartment.services.indexOf($id);$scope.apartment.services.splice(index,1)}else $scope.apartment.services.push($id);$scope.form.$setDirty()},$scope.cancel=function(){return $scope.form.$pristine||confirm($filter("translate")("admin.are_you_sure"))?void window.history.back():!1},$scope.saveApartment=function(){$scope.apartment._id?$scope.apartment.$update(function(){$flash.set("success","admin.changes_has_been_saved"),$location.path("/apartments")}):$scope.apartment.$save(function(){$flash.set("success","admin.changes_has_been_saved"),$location.path("/apartments")})};var map=null,marker=null,coords=[40.41153868,-3.70362707],zoom=6;$scope.apartment.geoposition&&(coords=$scope.apartment.geoposition.split(":")[0].split(",").map(function(a){return parseFloat(a)}),zoom=parseInt($scope.apartment.geoposition.split(":")[1]));var initMap=function(){var position=new google.maps.LatLng(coords[0],coords[1]),mapOptions={center:position,zoom:zoom,scrollwheel:!1,mapTypeId:google.maps.MapTypeId.HYBRID};map=new google.maps.Map(document.getElementById("map"),mapOptions),marker=new google.maps.Marker({map:map,position:position,draggable:!0,animation:google.maps.Animation.DROP}),google.maps.event.addListener(marker,"dragend",$scope.setCoords),google.maps.event.addListener(map,"zoom_changed",function(){$scope.apartment.geoposition=$scope.apartment.geoposition.replace(/\:(.*)/,":"+map.zoom),$scope.form.$setDirty(),$scope.$apply()})};$scope.centerAndSetMarkerOnAddress=function(){var search_address=$scope.search_address;if(!search_address){var country=$("#input-country option:selected").html(),province=$("#input-province option:selected").html(),town=$("#input-town option:selected").html();search_address=$scope.apartment.address+", "+town+", "+province+", "+country,$scope.search_address=search_address}var geocoder=new google.maps.Geocoder;geocoder.geocode({address:search_address},function(results,status){status===google.maps.GeocoderStatus.OK&&(map.setCenter(results[0].geometry.location),map.setZoom(16),marker.setPosition(results[0].geometry.location),$scope.apartment.geoposition=results[0].geometry.location.toString().slice(1).slice(0,-1).replace(" ","")+":"+map.zoom,$scope.form.$setDirty(),$scope.$apply())})},$scope.setCoords=function(ev){var coords=ev.latLng.toString().slice(1).slice(0,-1).replace(" ","")+":"+map.zoom;$scope.apartment.geoposition=coords,$scope.form.$setDirty(),$scope.$apply()},initMap()}),angular.module("adminApp").controller("ApartmentsApartmentsCtrl",function($rootScope,$timeout,$filter,$flash,$location,$scope,Apartment,ApartmentService){$rootScope.current_section="apartments",$scope.hasChanges=!1,$scope.apartment_index=null,$scope.apartment=null,$scope.apartment_block=Apartment,$scope.apartments=Apartment.apartments||[],$scope.saveApartmentsBlock=function(){ApartmentService.get({id:Apartment._id}).$promise.then(function(Apartment){Apartment.apartments=$scope.apartments,Apartment.$update(function(){$flash.set("success","admin.changes_has_been_saved"),window.history.back()})})},$scope.addApartment=function(){$scope.apartment={seasons:[],closed:[]}},$scope.cancelApartment=function(){($scope.apartmentForm.$pristine||confirm($filter("translate")("admin.are_you_sure")))&&($scope.apartment=$scope.apartment_index=null)},$scope.saveApartment=function(){null!==$scope.apartment_index?$scope.apartments[$scope.apartment_index]=angular.copy($scope.apartment):$scope.apartments.push(angular.copy($scope.apartment)),$scope.apartment=$scope.apartment_index=null,$scope.apartmentForm.$setPristine(),$scope.hasChanges=!0},$scope.editApartment=function($index){$scope.apartment=angular.copy($scope.apartments[$index]),$scope.apartment_index=$index},$scope.deleteApartment=function(){confirm($filter("translate")("admin.are_you_sure"))&&($scope.apartments.splice($scope.apartment_index,1),$scope.apartment=$scope.apartment_index=null)},$scope.duplicateApartment=function(){var apartment=angular.copy($scope.apartment);$scope.apartment_index=null,$scope.apartment=null,$timeout(function(){$scope.apartment=apartment,$scope.$apply()},100)},$scope.season_index=$scope.closed_index=null,$scope.season=$scope.closed=null,$scope.addSeason=function(){$scope.season={}},$scope.cancelSeason=function(){$scope.season=null,$scope.season_index=null},$scope.saveSeason=function(){null!==$scope.season_index?$scope.apartment.seasons[$scope.season_index]=angular.copy($scope.season):$scope.apartment.seasons.push($scope.season),$scope.season=$scope.season_index=null,$scope.apartmentForm.$setDirty()},$scope.editSeason=function($index){$scope.season_index=$index,$scope.season={},$scope.season=angular.copy($scope.apartment.seasons[$index]),$scope.renderSeasonDates()},$scope.deleteSeason=function($index){confirm($filter("translate")("admin.are_you_sure"))&&$scope.apartment.seasons.splice($index,1)},$scope.addClosed=function(){$scope.closed={}},$scope.cancelClosed=function(){$scope.closed=null,$scope.closed_index=null},$scope.saveClosed=function(){null!==$scope.closed_index?$scope.apartment.closed[$scope.closed_index]=angular.copy($scope.closed):$scope.apartment.closed.push($scope.closed),$scope.closed=$scope.closed_index=null,$scope.apartmentForm.$setDirty()},$scope.editClosed=function($index){$scope.closed_index=$index,$scope.closed={},$scope.closed=angular.copy($scope.apartment.closed[$index]),$scope.renderClosedDates()},$scope.deleteClosed=function($index){confirm($filter("translate")("admin.are_you_sure"))&&$scope.apartment.closed.splice($index,1)},$scope.dateOptions={startingDay:1,showWeeks:!1,showButtonBar:!1},$scope.renderSeasonDates=function(){angular.element($("#input-season-from")).controller("ngModel").$setViewValue(new Date($scope.season.from)),angular.element($("#input-season-from")).controller("ngModel").$render(),angular.element($("#input-season-to")).controller("ngModel").$setViewValue(new Date($scope.season.to)),angular.element($("#input-season-to")).controller("ngModel").$render()},$scope.renderClosedDates=function(){angular.element($("#input-closed-from")).controller("ngModel").$setViewValue(new Date($scope.closed.from)),angular.element($("#input-closed-from")).controller("ngModel").$render(),angular.element($("#input-closed-to")).controller("ngModel").$setViewValue(new Date($scope.closed.to)),angular.element($("#input-closed-to")).controller("ngModel").$render()},$scope.cancel=function(){return $scope.hasChanges&&!confirm($filter("translate")("admin.are_you_sure"))?!1:void window.history.back()}}),angular.module("adminApp").controller("ApartmentsImagesCtrl",function($rootScope,$scope,$filter,$flash,$location,Apartment,ApartmentService){$rootScope.current_section="apartments",$scope.apartment=Apartment,$scope.images=Apartment.images||[],$scope.uploading=[],$scope.uploadStart=function(files){$scope.uploading=files},$scope.deleteImage=function($index){confirm($filter("translate")("admin.are_you_sure"))&&$scope.images.splice($index,1)},$scope.uploadComplete=function(response){var images=[];$.each(response.data,function(index,item){images.push({file:item})}),$scope.images=$scope.images.concat(images)},$scope.saveImages=function(){ApartmentService.get({id:Apartment._id}).$promise.then(function(Apartment){Apartment.images=$scope.images,Apartment.$update(function(){$flash.set("success","admin.changes_has_been_saved"),window.history.back()})})},$scope.cancel=function(){return confirm($filter("translate")("admin.are_you_sure"))?void window.history.back():!1}}),angular.module("adminApp").config(["$routeProvider",function($routeProvider){$routeProvider.when("/bookings",{templateUrl:"assets/js/admin/views/bookings/index.html",controller:"BookingsIndexCtrl",resolve:{Apartments:function($q,ApartmentService,BookingService){var apartmentsDeferred=$q.defer(),bookingsDeferred=$q.defer();ApartmentService.query(function(apartments){apartmentsDeferred.resolve(apartments)});var resolvedApartments=0,apartmentsWithBookings=[];return apartmentsDeferred.promise.then(function(apartments){angular.forEach(apartments,function(apartment){BookingService.query({apartment_block:apartment._id},function(bookings){bookings.length>0&&(apartment.bookings=bookings,apartmentsWithBookings.push(apartment)),++resolvedApartments==apartments.length&&bookingsDeferred.resolve(apartmentsWithBookings)})})}),bookingsDeferred.promise}}}).when("/bookings/details/:id",{templateUrl:"assets/js/admin/views/bookings/details.html",controller:"BookingsDetailsCtrl",resolve:{Booking:function(BookingService,$route){return console.log($route),BookingService.get({id:$route.current.params.id}).$promise}}})}]),angular.module("adminApp").controller("BookingsIndexCtrl",function($rootScope,$scope,$flash,$filter,Apartments){$rootScope.current_section="bookings",$scope.apartments=Apartments,$scope.confirmBooking=function($apartment,$index){confirm($filter("translate")("admin.are_you_sure"))&&($scope.apartments[$apartment].bookings[$index].confirmed=!0,$scope.apartments[$apartment].bookings[$index].$update(function(){$flash.set("success","admin.changes_has_been_saved"),$flash.show()}))},$scope.deleteBooking=function($apartment,$index){confirm($filter("translate")("admin.are_you_sure"))&&$scope.apartments[$apartment].bookings[$index].$delete(function(){$flash.set("success","admin.object_has_been_removed"),$flash.show(),$scope.apartments[$apartment].bookings.splice($index,1),$scope.apartments[$apartment].bookings.length<1&&$scope.apartments.splice($apartment,1)})}}),angular.module("adminApp").controller("BookingsDetailsCtrl",function($rootScope,$scope,Booking){$rootScope.current_section="bookings",$scope.action="details",$scope.booking=Booking}),angular.module("adminApp").config(["$routeProvider",function($routeProvider){$routeProvider.when("/",{templateUrl:"assets/js/admin/views/dashboard/index.html",controller:"DashboardCtrl"})}]),angular.module("adminApp").controller("DashboardCtrl",["$rootScope",function($rootScope){$rootScope.current_section="dashboard"}]),angular.module("adminApp").config(["$routeProvider",function($routeProvider){$routeProvider.when("/users",{templateUrl:"assets/js/admin/views/users/index.html",controller:"UsersIndexCtrl",resolve:{Users:function(UserService){return UserService.query().$promise}}}).when("/users/create",{templateUrl:"assets/js/admin/views/users/form.html",controller:"UsersFormCtrl",resolve:{User:function(UserService){return new UserService},Countries:function(CountryService){return CountryService.query()}}}).when("/users/edit/:id",{templateUrl:"assets/js/admin/views/users/form.html",controller:"UsersFormCtrl",resolve:{User:function(UserService,$route){return UserService.get({id:$route.current.params.id}).$promise},Countries:function(CountryService){return CountryService.query()}}})}]),angular.module("adminApp").controller("UsersIndexCtrl",function($scope,$rootScope,$filter,$flash,$timeout,Users){$rootScope.current_section="users",$scope.users=Users,$scope.deleteUser=function($index){confirm($filter("translate")("admin.are_you_sure"))&&$scope.users[$index].$delete(function(){$flash.set("success","admin.object_has_been_removed"),$flash.show(),$scope.users.splice($index,1)})}}),angular.module("adminApp").controller("UsersFormCtrl",function($scope,$rootScope,$filter,$location,$flash,User,Countries){$rootScope.current_section="users",$scope.action=User._id?"editing":"creating",$scope.groups={2:"admin",3:"owner",4:"customer"},$scope.countries=Countries,$scope.user=User,$scope.dateOptions={startingDay:1,showWeeks:!1,showButtonBar:!1},$scope.openDatePicker=function(){$scope.opened=!0},1===User.group&&($scope.groups[1]="root"),$scope.saveUser=function(){$scope.password&&($scope.user.password=$scope.password),$scope.user._id?$scope.user.$update(function(){$flash.set("success","admin.changes_has_been_saved"),$location.path($rootScope.user.group>2?"/":"/users")}):$scope.user.$save(function(){$flash.set("success","admin.changes_has_been_saved"),$location.path("/users")})},$scope.uploadStart=function(){},$scope.uploadComplete=function(response){$scope.user.image=response.data,$scope.form.$setDirty()},$scope.deleteImage=function(){confirm($filter("translate")("admin.are_you_sure"))&&($scope.user.image=null)},$scope.cancel=function(){return $scope.form.$pristine||confirm($filter("translate")("admin.are_you_sure"))?void window.history.back():!1}});